<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Logging Execution Time Using AOP | rajeesh</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="What happens if your client complains that your application is running very slow!!! or in your load/stress testing you found that some functionalities are very slow in executing than expected. This is">
<meta property="og:type" content="article">
<meta property="og:title" content="Logging Execution Time Using AOP">
<meta property="og:url" content="http://rajeeshcv.com/2010/02/27/Logging-Execution-Time-Using-AOP/index.html">
<meta property="og:site_name" content="rajeesh">
<meta property="og:description" content="What happens if your client complains that your application is running very slow!!! or in your load/stress testing you found that some functionalities are very slow in executing than expected. This is">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Logging Execution Time Using AOP">
<meta name="twitter:description" content="What happens if your client complains that your application is running very slow!!! or in your load/stress testing you found that some functionalities are very slow in executing than expected. This is">
<meta name="twitter:creator" content="@cvrajeesh">
<link rel="publisher" href="https://www.google.com/+RajeeshCV">
  
    <link rel="alternative" href="/atom.xml" title="rajeesh" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-647217-9', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">rajeesh</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Sharing My Thoughts</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
          <a class="main-nav-link" href="/projects">Projects</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="q" value="site:http://rajeeshcv.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Logging-Execution-Time-Using-AOP" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2010/02/27/Logging-Execution-Time-Using-AOP/" class="article-date">
  <time datetime="2010-02-27T06:12:22.000Z" itemprop="datePublished">2010-02-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Logging Execution Time Using AOP
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>What happens if your client complains that your application is running very slow!!! or in your load/stress testing you found that some functionalities are very slow in executing than expected. This is the time where you go for profiling the execution, to analyse the root cause of these issues.</p>
<p>So how we could develop a profiler, where we don’t have to wrap our normal code in a profiling code.</p>
<p>Before going to create the profiler, we have to decide where to put the profiled information. In this tutorial, I am making use of <a href="http://logging.apache.org/log4net/" target="_blank" rel="external">Log4Net</a> as underlying layer to store this information. If you have not used <a href="http://logging.apache.org/log4net/" target="_blank" rel="external">Log4Net</a> before, I suggest you to read <a href="http://www.beefycode.com/post/Log4Net-Tutorial-pt-1-Getting-Started.aspx" target="_blank" rel="external">http://www.beefycode.com/post/Log4Net-Tutorial-pt-1-Getting-Started.aspx</a> as a starting point.</p>
<p>With the help of <strong>AOP (Aspect-Oriented Programming)</strong> we could do the profiling task without interrupting the actual code.</p>
<blockquote><p>AOP is a programming paradigm in which secondary or supporting functions are isolated from the main program’s business logic</p>
<footer><strong>Wikipedia</strong></footer></blockquote>
<p>So in order bring the AOP functionality into this application, I am going to use a third party library <a href="https://www.postsharp.net" target="_blank" rel="external">PostSharp</a>  which I believe this is one of the best that is available in the market.</p>
<p>So, now we have got the basic things to start with and now let’s start coding….</p>
<p>Start a new solution in visual studio and add a new console application project to it. Then add the below references to the newly created project</p>
<p>Add reference to the <em>Log4Net.dll</em>, <em>PostSharp.Laos.dll</em> and <em>PostSharp.Public.dll</em> (Please read  <a href="https://www.postsharp.net/documentation" target="_blank" rel="external">https://www.postsharp.net/documentation</a> to get the basic installation procedure). Next, create a new attribute class called <code>ProfileMethodAttribute</code> – this class is responsible for doing the profiling work. Make sure that you have decorated this class with <code>Serializable</code> attribute</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[Serializable]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ProfileMethodAttribute</span> : <span class="title">OnMethodBoundaryAspect</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnEntry</span><span class="params">(MethodExecutionEventArgs eventArgs)</span></span><br><span class="line">  </span>&#123;</span><br><span class="line">      ........</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnExit</span><span class="params">(MethodExecutionEventArgs eventArgs)</span></span><br><span class="line">  </span>&#123;</span><br><span class="line">     ......</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This class actually derives from <code>OnMethodBoundaryAspect</code>,  it has got two methods <code>OnEntry</code> and <code>OnExit</code> which we needed. These method will be called before the start of a method execution and at the end of method execution respectively, when this attribute is decorated against a method.</p>
<p>When a call comes to <code>OnEntry</code> method, we will first log the execution call using the <code>LoggerHelper</code>, then start a clock using another helper class <code>Profiler</code></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">LoggerHelper</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> Static instance of ILogger.</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ILog logger;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> Initializes static members of the <span class="xmlDocTag">&lt;see cref="LoggerHelper"/&gt;</span> class.</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="title">LoggerHelper</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        log4net.Config.XmlConfigurator.Configure();</span><br><span class="line">        logger = LogManager.GetLogger(<span class="keyword">typeof</span>(Program));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> Logs the specified message.</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="message"&gt;</span>The message.<span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Log</span><span class="params">(<span class="keyword">string</span> message)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">string</span> enableProfiling = ConfigurationManager.AppSettings[<span class="string">"EnableProfiling"</span>];</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">string</span>.IsNullOrEmpty(enableProfiling) || enableProfiling.ToLowerInvariant() == <span class="string">"true"</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            logger.Debug(message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> Logs the specified method name.</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="methodName"&gt;</span>Name of the method.<span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="url"&gt;</span>The URL to log.<span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="executionFlowMessage"&gt;</span>The execution flow message.<span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="actualMessage"&gt;</span>The actual message.<span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Log</span><span class="params">(<span class="keyword">string</span> methodName, <span class="keyword">string</span> url, <span class="keyword">string</span> executionFlowMessage, <span class="keyword">string</span> actualMessage)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        Log(ConstructLog(methodName, url, executionFlowMessage, actualMessage));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> Logs the specified method name.</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="methodName"&gt;</span>Name of the method.<span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="url"&gt;</span>The URL to log.<span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="executionFlowMessage"&gt;</span>The execution flow message.<span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="actualMessage"&gt;</span>The actual message.<span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="executionTime"&gt;</span>The execution time.<span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Log</span><span class="params">(<span class="keyword">string</span> methodName, <span class="keyword">string</span> url, <span class="keyword">string</span> executionFlowMessage, <span class="keyword">string</span> actualMessage, <span class="keyword">int</span> executionTime)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        Log(ConstructLog(methodName, url, executionFlowMessage, actualMessage, executionTime));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> Constructs the log.</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="methodName"&gt;</span>Name of the method.<span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="url"&gt;</span>The URL to be logged.<span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="executionFlowMessage"&gt;</span>The execution flow message.<span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="actualMessage"&gt;</span>The actual message.<span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span>Formatted string.<span class="xmlDocTag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">ConstructLog</span><span class="params">(<span class="keyword">string</span> methodName, <span class="keyword">string</span> url, <span class="keyword">string</span> executionFlowMessage, <span class="keyword">string</span> actualMessage)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrEmpty(methodName))</span><br><span class="line">        &#123;</span><br><span class="line">            sb.AppendFormat(<span class="string">"MethodName : &#123;0&#125;, "</span>, methodName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrEmpty(url))</span><br><span class="line">        &#123;</span><br><span class="line">            sb.AppendFormat(<span class="string">"Url : &#123;0&#125;, "</span>, url);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrEmpty(executionFlowMessage))</span><br><span class="line">        &#123;</span><br><span class="line">            sb.AppendFormat(<span class="string">"ExecutionFlowMessage : &#123;0&#125;, "</span>, executionFlowMessage);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrEmpty(actualMessage))</span><br><span class="line">        &#123;</span><br><span class="line">            sb.AppendFormat(<span class="string">"ActualMessage : &#123;0&#125;, "</span>, actualMessage);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">string</span> message = sb.ToString();</span><br><span class="line"></span><br><span class="line">        message = message.Remove(message.Length - <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> Constructs the log.</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="methodName"&gt;</span>Name of the method.<span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="url"&gt;</span>The URL to be logged.<span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="executionFlowMessage"&gt;</span>The execution flow message.<span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="actualMessage"&gt;</span>The actual message.<span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="executionTime"&gt;</span>The execution time.<span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span>Formatted string.<span class="xmlDocTag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">ConstructLog</span><span class="params">(<span class="keyword">string</span> methodName, <span class="keyword">string</span> url, <span class="keyword">string</span> executionFlowMessage, <span class="keyword">string</span> actualMessage, <span class="keyword">int</span> executionTime)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line"></span><br><span class="line">        sb.Append(ConstructLog(methodName, url, executionFlowMessage, actualMessage));</span><br><span class="line">        sb.AppendFormat(<span class="string">", ExecutionTime : &#123;0&#125;"</span>, executionTime);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> sb.ToString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>LoggerHelper</code> uses the <code>Log4Net</code> objects to log the message to configured location. <code>Profiler</code> class implemented like below</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> Helper class that wraps the timer based functionalities.</span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">Profiler</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> Lock object.</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">object</span> SyncLock = <span class="keyword">new</span> <span class="keyword">object</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> Variable that tracks the time.</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> Dictionary&lt;<span class="keyword">int</span>, Stack&lt;<span class="keyword">long</span>&gt;&gt; ProfilePool;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> Initializes static members of the <span class="xmlDocTag">&lt;see cref="Profiler"/&gt;</span> class.</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="title">Profiler</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        ProfilePool = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">int</span>, Stack&lt;<span class="keyword">long</span>&gt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> Starts this timer.</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Start</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">lock</span> (SyncLock)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">int</span> currentThreadId = Thread.CurrentThread.ManagedThreadId;</span><br><span class="line">            <span class="keyword">if</span> (ProfilePool.ContainsKey(currentThreadId))</span><br><span class="line">            &#123;</span><br><span class="line">                ProfilePool[currentThreadId].Push( Environment.TickCount );</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> timerStack = <span class="keyword">new</span> Stack&lt;<span class="keyword">long</span>&gt;();</span><br><span class="line">                timerStack.Push(DateTime.UtcNow.Ticks);</span><br><span class="line">                ProfilePool.Add(currentThreadId, timerStack);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> Stops timer and calculate the execution time.</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span>Execution time in milli seconds<span class="xmlDocTag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">Stop</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">lock</span> (SyncLock)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">long</span> currentTicks = DateTime.UtcNow.Ticks;</span><br><span class="line">            <span class="keyword">int</span> currentThreadId = Thread.CurrentThread.ManagedThreadId;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ProfilePool.ContainsKey(currentThreadId))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">long</span> ticks = ProfilePool[currentThreadId].Pop();</span><br><span class="line">                <span class="keyword">if</span> (ProfilePool[currentThreadId].Count == <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    ProfilePool.Remove(currentThreadId);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">var</span> timeSpan = <span class="keyword">new</span> TimeSpan(currentTicks - ticks);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> (<span class="keyword">int</span>)timeSpan.TotalMilliseconds;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>which stores the starting tick and calculate the time taken to execute when <code>Stop</code> is called.</p>
<p>Below is code snippet from <code>OnEntry</code> method</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnEntry</span><span class="params">(MethodExecutionEventArgs eventArgs)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">this</span>._methodName = <span class="keyword">this</span>.ExcludeMethodName ? <span class="keyword">string</span>.Empty : eventArgs.Method.Name;</span><br><span class="line">    <span class="keyword">this</span>._url = <span class="keyword">this</span>.IncludeUrl ? <span class="keyword">string</span>.Empty : (HttpContext.Current == <span class="keyword">null</span>) ? <span class="keyword">string</span>.Empty : HttpContext.Current.Request.Url.ToString();</span><br><span class="line"></span><br><span class="line">    LoggerHelper.Log(<span class="keyword">this</span>._methodName, <span class="keyword">this</span>._url, <span class="keyword">this</span>.EntryMessage, <span class="keyword">this</span>.Message);</span><br><span class="line">    Profiler.Start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>And <code>OnExist</code>, is almost similar expect there we will stop the profile timer.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnExit</span><span class="params">(MethodExecutionEventArgs eventArgs)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> count = Profiler.Stop();</span><br><span class="line">    LoggerHelper.Log(<span class="keyword">this</span>._methodName, <span class="keyword">this</span>._url, <span class="keyword">this</span>.EntryMessage, <span class="keyword">this</span>.Message, count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Next step is to use this and see whether it is logged properly. In order enable profiling for a method, you just needs to decorate it with the <code>ProfileMethod</code> attribute. Like below</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[ProfileMethod()]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SimpleMethod</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    Thread.Sleep(<span class="number">5000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Then if you run the application and calls this above method, a log entry will be created where you have configured which looks like below</p>
<p>PROFILING 2010-02-26 00:19:59,838 [1] Log MethodName : SimpleMethod<br>PROFILING 2010-02-26 00:20:04,865 [1] Log MethodName : SimpleMethod, ExecutionTime : 5002</p>
<p>Please least me know, if this helped you.</p>
<blockquote>
<p>Download the demo code from <a href="http://cdn.rajeeshcv.com/download/ProfilingSample.zip" target="_blank" rel="external">here</a></p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://rajeeshcv.com/2010/02/27/Logging-Execution-Time-Using-AOP/" data-id="ci9e7dsx6000hukktztlyx57j" class="article-share-link">Share</a>
      
        <a href="http://rajeeshcv.com/2010/02/27/Logging-Execution-Time-Using-AOP/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2010/02/28/JQueryUI-Datepicker-in-ASP-Net-MVC/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          JQueryUI Datepicker in ASP.Net MVC
        
      </div>
    </a>
  
  
    <a href="/2010/01/28/ASP-Net-MVC–Conditional-Rndering-Partial-Views-with-Action-T-Delegate/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">ASP.Net MVC – Conditional Rndering Partial Views with Action&lt;T&gt; Delegate</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>
</section>
        
          <aside id="sidebar">
  
    
  
    
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">May 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/06/">June 2014</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/08/">August 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/12/">December 2012</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/08/">August 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/12/">December 2011</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/11/">November 2011</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/10/">October 2011</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/04/">April 2011</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/02/">February 2011</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/12/">December 2010</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/09/">September 2010</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/06/">June 2010</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/04/">April 2010</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/02/">February 2010</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/01/">January 2010</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2009/12/">December 2009</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2009/06/">June 2009</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2009/05/">May 2009</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2008/10/">October 2008</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2008/06/">June 2008</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2008/05/">May 2008</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2015/05/07/Run-Gulp-Tasks-in-a-Predefined-Order/">Run Gulp Tasks in a Predefined Order</a>
          </li>
        
          <li>
            <a href="/2014/06/22/EmberJS-Error-Logging-in-Production/">EmberJS Error Logging in Production</a>
          </li>
        
          <li>
            <a href="/2014/06/12/EmberJS-How-to-Detect-User-Inactivity/">EmberJS - How to Detect User Inactivity</a>
          </li>
        
          <li>
            <a href="/2013/08/03/Visual-Studio-Debugging-Silverlight-Application-with-Chrome-and-Firefox/">Visual Studio : Debugging Silverlight Application with Chrome and Firefox</a>
          </li>
        
          <li>
            <a href="/2012/12/06/One-of-the-Top-E-Commerce-Website-in-India-Stores-Passwords-Incorrectly/">One of the Top E-Commerce Website in India Stores Passwords Incorrectly</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2015 Rajeesh C V<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
    <a href="/projects" class="mobile-nav-link">Projects</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    
<script>
  var disqus_shortname = 'rajeeshcv';
  
  var disqus_url = 'http://rajeeshcv.com/2010/02/27/Logging-Execution-Time-Using-AOP/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>

  </div>
</body>
</html>