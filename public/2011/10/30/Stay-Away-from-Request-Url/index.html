<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Stay Away from Request.Url | rajeesh</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="The title might be misleading but I will explain why we shouldn’t use the Request.Url in any asp.net application directly.
If you are writing an web application and you don’t know the environment of t">
<meta property="og:type" content="article">
<meta property="og:title" content="Stay Away from Request.Url">
<meta property="og:url" content="http://rajeeshcv.com/2011/10/30/Stay-Away-from-Request-Url/index.html">
<meta property="og:site_name" content="rajeesh">
<meta property="og:description" content="The title might be misleading but I will explain why we shouldn’t use the Request.Url in any asp.net application directly.
If you are writing an web application and you don’t know the environment of t">
<meta property="og:image" content="http://cdn.rajeeshcv.com/images/2011/10/20111030073847_image_2.png">
<meta property="og:image" content="http://cdn.rajeeshcv.com/images/2011/10/20111030073858_image_4.png">
<meta property="og:updated_time" content="2015-04-22T20:33:35.835Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Stay Away from Request.Url">
<meta name="twitter:description" content="The title might be misleading but I will explain why we shouldn’t use the Request.Url in any asp.net application directly.
If you are writing an web application and you don’t know the environment of t">
<meta name="twitter:creator" content="@cvrajeesh">
<link rel="publisher" href="https://www.google.com/+RajeeshCV">
  
    <link rel="alternative" href="/atom.xml" title="rajeesh" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-647217-9', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">rajeesh</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Sharing My Thoughts</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
          <a class="main-nav-link" href="/projects">Projects</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://rajeeshcv.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Stay-Away-from-Request-Url" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2011/10/30/Stay-Away-from-Request-Url/" class="article-date">
  <time datetime="2011-10-30T09:30:09.000Z" itemprop="datePublished">2011-10-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Stay Away from Request.Url
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>The title might be misleading but I will explain why we shouldn’t use the Request.Url in any asp.net application directly.</p>
<p>If you are writing an web application and you don’t know the environment of the server where it is getting deployed, then it is better not to use <code>Request.Url</code> it directly.</p>
<p><img src="http://cdn.rajeeshcv.com/images/2011/10/20111030073847_image_2.png" alt=""></p>
<p>This blog is running on a <a href="/2011/10/27/New-Outlook–Rolling-out-My-Own-Blog-Engine/" title="home grown blog engine">home grown blog engine</a>, which is written using asp.net MVC 3. For implementing some of the functionalities like generating sitemap.xml I had to get the root of the url(i.e. without any path). So I used the <code>Request.Url.GetLeftPart(UriPartial.Authority)</code> method and it worked perfectly on my local machine even when it is deployed my local machine IIS server. When I deployed my blog engine to <a href="https://appharbor.com" target="_blank" rel="external">Appharbor</a> environment, the generated sitemap.xml has a URL with port number like <em>www.rajeeshcv.com:4566</em> instead of just <em>www.rajeeshcv.com</em>.</p>
<h3 id="Why?">Why?</h3><p>After googling for some time I came across the solution posted <a href="https://appharbor.com" target="_blank" rel="external">Appharbor</a> knowledge base - <a href="https://support.appharbor.com/kb/getting-started/workaround-for-generating-absolute-urls-without-port-number" target="_blank" rel="external">workaround for generating absolute urls without port number</a>. In their environment there are load balancers which sits in front on the webserver, which uses a specific port number for contacting the server where the application is running. Below is a simple pictorial representation of that</p>
<p><img src="http://cdn.rajeeshcv.com/images/2011/10/20111030073858_image_4.png" alt="Network with load balancer"></p>
<p>So whenever we try to get <code>Request.Url</code>, application will get the actual request Url received by that webserver, which will have the port number also.</p>
<h3 id="How_to_solve_it">How to solve it</h3><p>Appharbor has provided a code snippet in the same article but it didn’t worked for me, I was still getting port number in the generated Url. My assumption is that, there is condition check for ignoring the local request so that it will work correctly in the local development environment.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (httpContext.Request.IsLocal)</span><br><span class="line">&#123;</span><br><span class="line">    uriBuilder.Port = httpContext.Request.Url.Port;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>According to the MSDN documentation</p>
<blockquote>
<p>The <code>IsLocal</code> property returns true if the IP address of the request originator is 127.0.0.1 or if the IP address of the request is the same as the server’s IP address.</p>
</blockquote>
<p>In my case I think <code>IsLocal</code> was true (I really don’t the exact reason!!!). So instead of using the appharbor code snippet I came across a code from <a href="http://www.funnelweblog.com/" target="_blank" rel="external">FunnelWeb</a> which does the same (HttpRequestExtensions.cs)</p>
<p>Here is my version of that code</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> Environments the specific request URL.</span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="request"&gt;</span>The request.<span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span><span class="xmlDocTag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;remarks&gt;</span></span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> Code from FunnelWeb:  https://bitbucket.org/TheBlueSky/funnelweb/src/b64c74f361d3/src/FunnelWeb/Utilities/HttpRequestExtensions.cs</span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/remarks&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Uri <span class="title">EnvironmentSpecificRequestUrl</span>(<span class="params"><span class="keyword">this</span> HttpRequestBase request</span>)</span><br><span class="line"></span>&#123;</span><br><span class="line"></span><br><span class="line">    UriBuilder hostUrl = <span class="keyword">new</span> UriBuilder();</span><br><span class="line">    <span class="keyword">string</span> hostHeader = request.Headers[<span class="string">"Host"</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hostHeader.Contains(<span class="string">":"</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        hostUrl.Host = hostHeader.Split(<span class="string">':'</span>)[<span class="number">0</span>];</span><br><span class="line">        hostUrl.Port = Convert.ToInt32(hostHeader.Split(<span class="string">':'</span>)[<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        hostUrl.Host = hostHeader;</span><br><span class="line">        hostUrl.Port = -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Uri url = request.Url;</span><br><span class="line">    UriBuilder uriBuilder = <span class="keyword">new</span> UriBuilder(url);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (String.Equals(hostUrl.Host, <span class="string">"localhost"</span>, StringComparison.OrdinalIgnoreCase) || hostUrl.Host == <span class="string">"127.0.0.1"</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Do nothing</span></span><br><span class="line">        <span class="comment">// When we're running the application from localhost (e.g. debugging from Visual Studio), we'll keep everything as it is.</span></span><br><span class="line">        <span class="comment">// We're not using request.IsLocal because it returns true as long as the request sender and receiver are in same machine.</span></span><br><span class="line">        <span class="comment">// What we want is to only ignore the requests to 'localhost' or the loopback IP '127.0.0.1'.</span></span><br><span class="line">        <span class="keyword">return</span> uriBuilder.Uri;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// When the application is run behind a load-balancer (or forward proxy), request.IsSecureConnection returns 'true' or 'false'</span></span><br><span class="line">    <span class="comment">// based on the request from the load-balancer to the web server (e.g. IIS) and not the actual request to the load-balancer.</span></span><br><span class="line">    <span class="comment">// The same is also applied to request.Url.Scheme (or uriBuilder.Scheme, as in our case).</span></span><br><span class="line">    <span class="keyword">bool</span> isSecureConnection = String.Equals(request.Headers[<span class="string">"X-Forwarded-Proto"</span>], <span class="string">"https"</span>, StringComparison.OrdinalIgnoreCase);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isSecureConnection)</span><br><span class="line">    &#123;</span><br><span class="line">        uriBuilder.Port = hostUrl.Port == -<span class="number">1</span> ? <span class="number">443</span> : hostUrl.Port;</span><br><span class="line">        uriBuilder.Scheme = <span class="string">"https"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        uriBuilder.Port = hostUrl.Port == -<span class="number">1</span> ? <span class="number">80</span> : hostUrl.Port;</span><br><span class="line">        uriBuilder.Scheme = <span class="string">"http"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    uriBuilder.Host = hostUrl.Host;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> uriBuilder.Uri;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Conclusion">Conclusion</h3><p>IMHO this is a limitation with .Net framework itself because here we have to modify the behaviour of the framework class to achieve what we really want . If there is way in which the IIS web server can detect the topology on which it is running, then the <code>HttpRequest.Url</code> could be implemented correctly. So that the developer need not to worry about the deployment scenarios(at least in this simple case).</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://rajeeshcv.com/2011/10/30/Stay-Away-from-Request-Url/" data-id="ciffni8rs0009isktxhiv9sof" class="article-share-link">Share</a>
      
        <a href="http://rajeeshcv.com/2011/10/30/Stay-Away-from-Request-Url/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2011/11/15/How-to-Move-Directories-Across-SVN-Repositories/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          How to Move Directories Across SVN Repositories
        
      </div>
    </a>
  
  
    <a href="/2011/10/27/New-Outlook–Rolling-out-My-Own-Blog-Engine/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">New Outlook – Rolling out My Own Blog Engine</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>
</section>
        
          <aside id="sidebar">
  
    
  
    
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">May 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/06/">June 2014</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/08/">August 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/12/">December 2012</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/08/">August 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/12/">December 2011</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/11/">November 2011</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/10/">October 2011</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/04/">April 2011</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/02/">February 2011</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/12/">December 2010</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/09/">September 2010</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/06/">June 2010</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/04/">April 2010</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/02/">February 2010</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/01/">January 2010</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2009/12/">December 2009</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2009/06/">June 2009</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2009/05/">May 2009</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2008/10/">October 2008</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2008/06/">June 2008</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2008/05/">May 2008</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2015/10/13/Build-Parsers-using-PEG-js/">Build Parsers using PEG.js</a>
          </li>
        
          <li>
            <a href="/2015/10/07/A-Different-Way-to-Organize-JavaScripts-in-ASP-Net-MVC/">A Different Way to Organize JavaScripts in ASP.Net MVC</a>
          </li>
        
          <li>
            <a href="/2015/05/08/How-to-Fill-Remaining-Height-with-a-Div/">How to Fill Remaining Height with a Div</a>
          </li>
        
          <li>
            <a href="/2015/05/07/Run-Gulp-Tasks-in-a-Predefined-Order/">Run Gulp Tasks in a Predefined Order</a>
          </li>
        
          <li>
            <a href="/2014/06/22/EmberJS-Error-Logging-in-Production/">EmberJS Error Logging in Production</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2015 Rajeesh C V<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
    <a href="/projects" class="mobile-nav-link">Projects</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    
<script>
  var disqus_shortname = 'rajeeshcv';
  
  var disqus_url = 'http://rajeeshcv.com/2011/10/30/Stay-Away-from-Request-Url/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>

  </div>
</body>
</html>